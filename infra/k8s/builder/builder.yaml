# Reference: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
apiVersion: apps/v1
kind: Deployment
metadata:
  name: docker
spec:
  selector:
    matchLabels:
      app: docker
  template:
    metadata:
      labels:
        app: docker
    spec:
      containers:
      - name: docker
        image: ${IMAGE}
        ports:
        - containerPort: 8080
        securityContext:
          privileged: true
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        env:
          - name: DOMAIN
            value: "${DOMAIN}"
          - name: FRONTEND_HOST
            value: "${FRONTEND_HOST}"
          - name: API_HOST
            value: "${API_HOST}"
          - name: DEPLOYMENTS_DOMAIN
            value: "${DEPLOYMENTS_DOMAIN}"
          - name: ENVIRONMENT
            value: "${ENVIRONMENT}"
          - name: PROJECT_NAME
            value: "${PROJECT_NAME}"
          - name: STACK_NAME
            value: "${STACK_NAME}"
          - name: BACKEND_CORS_ORIGINS
            value: "${BACKEND_CORS_ORIGINS}"
          - name: FIRST_SUPERUSER
            value: "${FIRST_SUPERUSER}"
          - name: FIRST_SUPERUSER_FULL_NAME
            value: "${FIRST_SUPERUSER_FULL_NAME}"
          - name: SMTP_HOST
            value: "${SMTP_HOST}"
          - name: SMTP_USER
            value: "${SMTP_USER}"
          - name: EMAILS_FROM_EMAIL
            value: "${EMAILS_FROM_EMAIL}"
          - name: SMTP_TLS
            value: "${SMTP_TLS}"
          - name: SMTP_SSL
            value: "${SMTP_SSL}"
          - name: SMTP_PORT
            value: "${SMTP_PORT}"
          - name: POSTGRES_SERVER
            value: "${POSTGRES_SERVER}"
          - name: POSTGRES_PORT
            value: "${POSTGRES_PORT}"
          - name: POSTGRES_DB
            value: "${POSTGRES_DB}"
          - name: POSTGRES_USER
            value: "${POSTGRES_USER}"
          - name: POSTGRES_SSL_ENABLED
            value: "${POSTGRES_SSL_ENABLED}"
          - name: REDIS_SERVER
            value: "${REDIS_SERVER}"
          - name: SENTRY_DSN
            value: "${SENTRY_DSN}"
          - name: DOCKER_IMAGE_BACKEND
            value: "${DOCKER_IMAGE_BACKEND}"
          - name: DOCKER_IMAGE_FRONTEND
            value: "${DOCKER_IMAGE_FRONTEND}"
          - name: AWS_DEPLOYMENT_BUCKET
            value: "${AWS_DEPLOYMENT_BUCKET}"
          - name: ECR_REGISTRY_URL
            value: "${ECR_REGISTRY_URL}"
          - name: AWS_REGION
            value: "${AWS_REGION}"
          - name: DOCKER_HOST
            value: "${DOCKER_HOST}"
          - name: SECRET_KEY
            value: "${SECRET_KEY}"
          - name: FIRST_SUPERUSER_PASSWORD
            value: "${FIRST_SUPERUSER_PASSWORD}"
          - name: SMTP_PASSWORD
            value: "${SMTP_PASSWORD}"
          - name: POSTGRES_PASSWORD
            value: "${POSTGRES_PASSWORD}"
        volumeMounts:
        - mountPath: /var/lib/docker
          name: docker-graph-storage
      volumes:
      - name: docker-graph-storage
        emptyDir: {}

---
# Reference: https://kubernetes.io/docs/concepts/services-networking/service/
apiVersion: v1
kind: Service
metadata:
  name: docker
spec:
  selector:
    app: docker
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080

---
# Reference: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: docker-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: docker
  minReplicas: 1
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
